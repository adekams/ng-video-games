<div class="ui container">
  <app-searchbar [showSearch]="true"></app-searchbar>
  <div
    class="ui basic segment"
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    "
  >
    <div class="custom-select" style="flex: 1; min-width: 200px">
      <select
        [ngModel]="selectedSortOption()"
        (ngModelChange)="onSortOptionChange($event)"
        title="Sort games by"
      >
        @for (option of SORT_OPTIONS; track $index) {
          <option [ngValue]="option">
            {{ option.name }}
          </option>
        }
      </select>
    </div>

    <div
      class="ui basic segment"
      style="
        padding: 0;
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 0;
      "
    >
      <button
        class="ui button"
        [class.active]="sortOrderValue() === 'desc'"
        (click)="onSortResults('desc')"
        title="Sort descending"
      >
        <i class="large sort alphabet down icon"></i>
        Desc
      </button>
      <button
        class="ui button"
        [class.active]="sortOrderValue() === 'asc'"
        (click)="onSortResults('asc')"
        title="Sort ascending"
      >
        <i class="large sort alphabet up icon"></i>
        Asc
      </button>
    </div>
  </div>

  <!-- Games Container with Infinite Scroll -->
  <div
    class="ui basic segment"
    [ngClass]="{ loading: pending() }"
    style="background: transparent !important"
  >
    <div class="ui four doubling cards">
      @for (game of games(); track $index) {
        <ng-container>
          <button
            class="ui card"
            (click)="goToItem(game)"
            [attr.aria-label]="'View ' + game?.name"
          >
            <div class="image">
              @if (game?.background_image) {
                <img
                  [src]="game?.background_image"
                  [alt]="game?.name"
                  loading="lazy"
                />
              } @else {
                <img
                  src="https://res.cloudinary.com/adenike/image/upload/v1642002314/no-image_iah8ux.png"
                  alt="No image available"
                  loading="lazy"
                />
              }
            </div>
            <div class="content">
              <div class="header primary-color">{{ game?.name }}</div>
              <div class="platforms">
                @if (game?.parent_platforms?.length) {
                  @for (
                    item of game?.parent_platforms;
                    let last = $last;
                    track $index
                  ) {
                    <span>
                      <img
                        class="game-platform"
                        src="assets/images/platforms/{{
                          convertPlatformNametoLowercase(item?.platform?.name)
                        }}.svg"
                        [alt]="item?.platform?.name"
                        title="{{ item?.platform?.name }}"
                      />
                    </span>
                  }
                }
              </div>
              <div style="margin-top: 12px; font-size: 13px; opacity: 0.8">
                @if (game && game.ratings && game.ratings.length) {
                  <img
                    class="review-star"
                    src="assets/icons/star.svg"
                    alt="review-star"
                  />
                  {{ game.ratings[0].count || 0 }} reviews
                }
              </div>
            </div>
          </button>
        </ng-container>
      }
    </div>

    @if (shouldShowEmptyState()) {
      <div style="text-align: center; padding: 40px">
        <h3>No games found</h3>
        <p>Try adjusting your search or sorting options</p>
      </div>
    }

    <!-- Infinite Scroll Trigger Element (always present for observer) -->
    <div
      #scrollTrigger
      style="height: 20px; margin-top: 20px"
      aria-hidden="true"
    ></div>

    <!-- End of List Message -->
    @if (shouldShowEndMessage()) {
      <div
        style="
          text-align: center;
          padding: 20px;
          opacity: 0.6;
          margin-top: 20px;
        "
      >
        <p style="font-size: 14px">All games loaded</p>
      </div>
    }
  </div>

  @if (pending() && gameCount() > 0) {
    <div
      style="text-align: center; padding: 20px; margin-top: 20px; opacity: 0.6"
    >
      <div class="ui active spinner"></div>
      <p style="margin-top: 10px; font-size: 14px; opacity: 0.8">
        Loading more games...
      </p>
    </div>
  }
</div>
